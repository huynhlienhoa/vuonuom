<!DOCTYPE html>
<html>

<head>
    <title>Vuon uom 2023</title>
    <link rel="icon" type="image/x-icon" href="./axsets/image/logo_vuon_uom.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />

    <script src="https://code.jquery.com/jquery-1.9.1.js"></script>
    <script src="https://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
    <link rel="stylesheet" type="text/css" href="//code.jquery.com/ui/1.9.2/themes/base/jquery-ui.css">
    <style>
        .c-1-color {
            background: red;
        }

        .c-2-color {
            background: yellow;
        }

        .c-3-color {
            background: green;
        }

        .c-4-color {
            background: blue;
        }

        .c-5-color {
            background: purple;
        }

        .material-symbols-outlined {
            font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24
        }

        .glass_screen {
            background-size: cover;
            /* <------ */
            background-repeat: no-repeat;
            background-position: center center;
            /* optional, center the image */
            background-image: url('./axsets/image/grass.png');
            height: 184px;
        }

        .cloud_screen_1 {
            background-size: cover;
            /* <------ */
            background-repeat: no-repeat;
            background-position: center center;
            /* optional, center the image */
            background-image: url('./axsets/image/cloud1.png');
            height: 100px;
            width: 380px;
            top: 100px;
            left: 100px;
            position: absolute;
            animation: cloud_move_1 60s infinite, cloud_opacity_1 infinite;
        }

        .cloud_screen_2 {
            background-size: cover;
            /* <------ */
            background-repeat: no-repeat;
            background-position: center center;
            /* optional, center the image */
            background-image: url('./axsets/image/cloud2.png');
            height: 100px;
            width: 700px;
            top: 100px;
            left: 100px;
            position: absolute;
            animation: cloud_move_2 50s infinite, cloud_opacity_1 10s ease-in-out infinite;
        }

        .cloud_screen_3 {
            background-size: cover;
            /* <------ */
            background-repeat: no-repeat;
            background-position: center center;
            /* optional, center the image */
            background-image: url('./axsets/image/cloud3.png');
            height: 100px;
            width: 650px;
            top: 100px;
            left: 100px;
            position: absolute;
            animation: cloud_move_3 40s infinite, cloud_opacity_1 10s 2s infinite;
        }

        .tree_screen_1 {
            background-size: cover;
            /* <------ */
            background-repeat: no-repeat;
            background-position: center center;
            /* optional, center the image */
            background-image: url('./axsets/image/tree1.png');
            height: 200px;
            width: 600px;
            bottom: 100px;
            left: 0px;
            position: absolute;
        }

        .tree_screen_2 {
            background-size: cover;
            /* <------ */
            background-repeat: no-repeat;
            background-position: center center;
            /* optional, center the image */
            background-image: url('./axsets/image/tree2.png');
            height: 200px;
            width: 600px;
            bottom: -20px;
            right: 0px;
            position: absolute;
        }

        .tree_screen_3 {
            background-size: cover;
            /* <------ */
            background-repeat: no-repeat;
            background-position: center center;
            /* optional, center the image */
            background-image: url('./axsets/image/tree3.png');
            height: 200px;
            width: 600px;
            bottom: 100px;
            right: 0px;
            position: absolute;
        }

        .tree_screen_4 {
            background-size: cover;
            /* <------ */
            background-repeat: no-repeat;
            background-position: center center;
            /* optional, center the image */
            background-image: url('./axsets/image/tree4.png');
            height: 200px;
            width: 600px;
            bottom: -20px;
            left: 0px;
            position: absolute;
        }

        .background_site {
            background: #b2ffc06e;
            color: black;
        }

        @keyframes cloud_move_1 {
            from {
                left: -400px;
            }

            to {
                left: 100%;
            }
        }

        @keyframes cloud_move_2 {
            from {
                left: -600px;
            }

            to {
                left: 100%;
            }
        }

        @keyframes cloud_move_3 {
            from {
                left: -100px;
            }

            to {
                left: 100%;
            }
        }

        @keyframes cloud_opacity_1 {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0;
            }

            100% {
                opacity: 1;
            }
        }

        #value_nhietdo::before {
            content: "Nhiệt độ: "
        }

        #value_doam::before {
            content: "Độ ẩm: "
        }
    </style>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="./css/nouislider.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/15.7.1/nouislider.min.js"
        integrity="sha512-UOJe4paV6hYWBnS0c9GnIRH8PLm2nFK22uhfAvsTIqd3uwnWsVri1OPn5fJYdLtGY3wB11LGHJ4yPU1WFJeBYQ=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js" charset="utf-8"></script>
</head>

<body>
    <div class="absolute top-0 left-0 h-screen w-screen"
        style="background-color: skyblue; z-index: -1; overflow: hidden;">
        <div class="absolute bottom-0 left-0 w-full glass_screen"></div>
        <div class="cloud_screen_1 "></div>
        <div class="cloud_screen_2 "></div>
        <div class="cloud_screen_3 "></div>
        <div class="tree_screen_1"></div>
        <div class="tree_screen_2"></div>
        <div class="tree_screen_3"></div>
        <div class="tree_screen_4"></div>
    </div>
    <div class="flex flex-col h-screen space-y-10 p-8">
        <div class="flex flex-row basis-1/2 space-x-8">
            <div class="basis-1/3 flex flex-col " >
                <div class="px-8">
                <img src="./axsets/image/logo_vuon_uom.png" alt="logo" style="width:150px;height:150px;">
                <h2 class="text-4xl pt-3"> Vườn ươm cà chua </h2>
                <!-- <h2 class="text-2xl text-center shadow-2xl p-4 rounded-xl border-2">Tiêu đề</h2> -->
            </div>
            </div>
            <div class="grow"></div>

            <div class="basis-1/3 max-w-xs border-2 text-center shadow-2xl flex flex-col rounded-xl">
                <h2 class="text-2xl p-4 ">Nhiệt độ</h2>
                <span class="text-6xl material-symbols-outlined w-full">
                    dew_point
                </span>
                <div class="text-4xl flex justify-center content-center gap-x-2">
                    <div id="current_temperate_status" class="rounded-full w-10 h-10 bg-green-900"></div>
                    <span id="current_temperate">36</span>
                    <span>°C</span>
                </div>
            </div>
            <div class="basis-1/3 max-w-xs border-2 text-center shadow-2xl flex flex-col rounded-xl ">
                <h2 class="text-2xl p-4 ">Độ ẩm</h2>
                <span class="text-6xl material-symbols-outlined w-full">
                    humidity_mid
                </span>
                <div class="text-4xl flex justify-center content-center gap-x-2">
                    <div id="current_humidity_status" class="rounded-full w-10 h-10 bg-green-900"></div>
                    <span id="current_humidity">45</span>
                    <span>%</span>
                </div>
            </div>
        </div>



        <div class="flex flex-row basis-1/2 space-x-10">
            <div class="basis-1/3 border-2 text-xl shadow-2xl p-4 rounded-xl background_site ">
                <div class="text-xl text-center ">
                    <h2 class="text-2xl">Điều khiển</h2>
                </div>
                <div class="p-4">
                    <div class="form-check form-switch ">
                        <input class="form-check-input" type="checkbox" role="switch" id="btn_auto" disabled checked>
                        <label class="form-check-label" for="btn_auto">Tự động</label>
                    </div>
                    <div class="form-check form-switch ">
                        <input class="form-check-input" type="checkbox" role="switch" id="btn_light" disabled checked>
                        <label class="form-check-label" for="btn_light">Đèn</label>
                    </div>
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" role="switch" id="btn_water" disabled checked>
                        <label class="form-check-label" for="btn_water">Tưới nước</label>
                    </div>
                </div>

                <div>
                    <span id="value_nhietdo"></span>
                    <div id="slider_nhietdo"></div>
                </div>
                <div>
                    <span id="value_doam"></span>
                    <div id="slider_doam"></div>
                </div>

            </div>



            <div class="basis-2/3 text-2xl text-center border-2 shadow-2xl rounded-xl background_site">
                <p class="mt-4">Đồ thị Nhiệt độ, Độ ẩm theo thời gian </P>
                <div class="w-full p-3 relative" style="height: calc(100% - 40px - 1.5rem)">
                    <div id="plotarea" class="w-full h-full"></div>
                </div>

            </div>
        </div>
    </div>
    <div class="modal" tabindex="-1" role="dialog" id="loginDialog">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Login info</h5>
            </div>
            <form id="loginInfo" class="needs-validation" novalidate>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="exampleInputEmail1">Email address</label>
                        <input type="email" class="form-control" id="username" required aria-describedby="emailHelp" placeholder="Enter email">
                    </div>
                    <div class="form-group">
                        <label for="exampleInputPassword1">Password</label>
                        <input type="password" class="form-control" id="pass" required placeholder="Password">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-primary">Login</button>
                </div>
            </form>
          </div>
        </div>
      </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
        crossorigin="anonymous"></script>
    <script>

        // Khoi tao slider
        var slider_nhietdo = document.getElementById('slider_nhietdo');
        noUiSlider.create(slider_nhietdo, {
            start: [20, 25, 28, 33],
            connect: true,
            step: 5,
            range: {
                'min': [0],
                'max': [50],
                // tooltips:true
            }

        });


        var slider_doam = document.getElementById('slider_doam');

        noUiSlider.create(slider_doam, {
            start: [40, 45, 60, 65],
            step: 5,
            connect: true,
            range: {
                'min': [20],
                'max': [80],
                // tooltips:true
            }
        });

        // Hien thi
        var value_nhietdo = document.getElementById("value_nhietdo");
        slider_nhietdo.noUiSlider.on('update', function (values, handle) {
            value_nhietdo.innerHTML = values.map(d => String(+d)).join('-');
        });
        var value_doam = document.getElementById("value_doam");
        slider_doam.noUiSlider.on('update', function (values, handle) {
            value_doam.innerHTML = values.map(d => String(+d)).join('-');
        });
        const divElements = document.querySelectorAll('.noUi-connect');
        if (divElements.length >= 2) {
            //thanh nhiệt độ
            divElements[0].style.backgroundColor = 'yellow';
            divElements[1].style.backgroundColor = 'green';
            divElements[2].style.backgroundColor = 'yellow';

            //thanh độ ẩm
            divElements[3].style.backgroundColor = 'yellow';
            divElements[4].style.backgroundColor = 'green';
            divElements[5].style.backgroundColor = 'yellow';
        }
        else {
            console.log('Please double check');
        }
    </script>
    <script type="module">
        import { firebase_init } from "./scripts/firebase-connect.js";
        $(window).load(function() {
            window.addEventListener('load', function() {
            // Fetch all the forms we want to apply custom Bootstrap validation styles to
            var forms = document.getElementById('loginInfo');
            // Loop over them and prevent submission
            form.addEventListener('submit', function(event) {
                    if (form.checkValidity() === false) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');

                }, false);
            });
            $('#loginDialog').modal('show');
        const status_color = ['bg-green-900', 'bg-yellow-400', 'bg-red-600'];
        // connect firebase
        const setHandle = {
            elements: [[btn_auto, 'chedo'], [btn_light, 'densuoi'], [btn_water, 'maybom']],
            callback: (dom, key, f) => {
                dom.addEventListener('change', (event) => {
                    f(key, event.target.checked);
                });
            },
            f: () => { },
            excute: function () {
                this.elements.forEach(([dom, key]) => this.callback(dom, key, this.f))
            }
        };
        const setlLimit = {
            elements: [[slider_nhietdo, 'nhietdo'], [slider_doam, 'doam']],
            callback: (dom, key, f) => {
                dom.noUiSlider.on('change', function (values) {
                    f(key, values.map(d => +d));
                });
            },
            f: () => { },
            excute: function () {
                this.elements.forEach(([dom, key]) => this.callback(dom, key, this.f))
            }
        };

        firebase_init({
            control: { get: control_handle, set: setHandle },
            limit: { get: limit_handle, set: setlLimit },
            current: { get: current_handle },
            plot: { get: getPlotData }
        });

        // update che do
        function control_handle({ chedo, densuoi, maybom }) {
            btn_auto.checked = chedo;
            btn_auto.disabled = false;
            // auto
            if (chedo) {
                btn_light.disabled = true;
                btn_water.disabled = true;
                btn_light.checked = densuoi;
                btn_water.checked = maybom;
            } else // manual
            {
                btn_light.disabled = false;
                btn_water.disabled = false;
                btn_light.checked = densuoi;
                btn_water.checked = maybom;
            }
        }

        // update limit
        function limit_handle({ nhietdo, doam }) {
            slider_nhietdo.noUiSlider.set(nhietdo);
            slider_doam.noUiSlider.set(doam);
            updateStatus();
        }

        // update gia tri hien tai
        function current_handle({ doam, nhietdo }) {
            current_temperate.innerText = nhietdo;
            current_humidity.innerText = doam;
            updateStatus();
        }
        function updateStatusSingle(dom, value, range) {
            if ((value >= range[1]) && (value <= range[2])) {
                // green
                if (!dom.classList.contains(status_color[0])) {
                    dom.classList.remove(status_color[1]);
                    dom.classList.remove(status_color[2]);
                    dom.classList.add(status_color[0]);
                }
            } else if ((value >= range[0]) && (value <= range[3])) {
                // yellow
                if (!dom.classList.contains(status_color[1])) {
                    dom.classList.remove(status_color[0]);
                    dom.classList.remove(status_color[2]);
                    dom.classList.add(status_color[1]);
                }
            } else {
                //red
                if (!dom.classList.contains(status_color[2])) {
                    dom.classList.remove(status_color[1]);
                    dom.classList.remove(status_color[0]);
                    dom.classList.add(status_color[2]);
                }
            }
        }
        function updateStatus() {
            updateStatusSingle(current_temperate_status, +current_temperate.innerText, slider_nhietdo.noUiSlider.get().map(d => +d));
            updateStatusSingle(current_humidity_status, +current_humidity.innerText, slider_doam.noUiSlider.get().map(d => +d));
        }
        // Ve do thi
        Plotly.newPlot(plotarea, [
            {
                name: 'Nhiệt độ',
                x: [1, 2, 3, 4, 5],
                y: [1, 2, 4, 8, 16]
            },
            {
                name: 'Độ ẩm',
                x: [1, 2, 3, 4, 5],
                y: [4, 1, 5, 8, 10]
            }
        ], {
            margin: { t: 20, b: 40 }
        }, { responsive: true });
        function getPlotData(data) {
            const time = data.map(d => new Date(d.Ts));
            const nhietdo = data.map(d => d.nhietdo);
            const doam = data.map(d => d.doam);
            const update = {
                x: [time, time],
                y: [nhietdo, doam],
            }
            console.log(update)
            Plotly.update(plotarea, update, {}, [0, 1]);
        }
    })
    </script>

</body>

</html>